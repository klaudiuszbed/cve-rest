"""Data-related endpoints."""

import pymongo
from flask import Blueprint, jsonify, request, redirect, url_for
from application.auth import token_required
from application import db_connect

cve_bp = Blueprint("cve_bp", __name__)
collection = db_connect(collection_name="cve")


@cve_bp.route("/")
def home_redirect():
    """Endpoint for user redirection."""
    return redirect(url_for("cve_bp.get_cve"))


@cve_bp.route('/cve', methods=["GET"])
@token_required
def get_cve():
    """
    Endpoint for serving GET requests.
    Returns json CVE records.
    """

    # get values from query string
    amount = request.args.get("amount", type=int)

    # base query, if user doesn't specify amount return 10 CVE
    results = collection.find().limit(10).sort("date", pymongo.DESCENDING)

    # if user specify amount of CVEs to return, limit query
    if amount:
        if amount > 2000:  # only 2000 CVEs at once
            return jsonify(message="You've requested too many CVEs at once. Max is 2000.")
        results = collection.find().limit(amount).sort(
            "date", pymongo.DESCENDING)

    cve_data = []

    for cve in results:
        cve_object = {
            "title": cve["title"],
            "date": cve["date"],
            "content": cve["content"],
            "references": cve["references"]
        }
        cve_data.append(cve_object)
    return jsonify(data=cve_data)
