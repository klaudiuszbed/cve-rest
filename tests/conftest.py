from application import create_app, db_client
import pytest
import json


@pytest.fixture()
def app():
    app = create_app("TestConfig")
    yield app
    db = db_client.test_cve_db
    db.user.drop()


@pytest.fixture()
def test_client(app):
    return app.test_client()


@pytest.fixture()
def user_register(test_client):
    """Register user and returns credentials."""
    username = "properUsername"
    password = "properPassword12"

    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'}

    data = {
        'username': username,
        'password': password}

    # dumps - turn python object into a json string
    test_client.post('/user/register', data=json.dumps(data), headers=headers)
    return data


@pytest.fixture()
def user_token(test_client, user_register):
    data = user_register
    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'}

    response = test_client.post(
        "/user/login", data=json.dumps(data), headers=headers)
    response_data = json.loads(response.data)
    token = response_data["token"]
    return token
