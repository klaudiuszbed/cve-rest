"""Pytest fixtures for unit tests."""

import json
import pytest
from application import create_app, db_client


@pytest.fixture()
def app():
    """
    Fixture for app creation.
    yields app instance and after tests perform database clean-up
    """
    app = create_app("TestConfig")
    yield app
    database = db_client.test_cve_db
    database.user.drop()


@pytest.fixture()
def test_client(app):
    """Returns test client."""
    return app.test_client()


@pytest.fixture()
def user_register(test_client):
    """Register user and returns credentials."""
    username = "properUsername"
    password = "properPassword12"

    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'}

    data = {
        'username': username,
        'password': password}

    # dumps - turn python object into a json string
    test_client.post('/user/register', data=json.dumps(data), headers=headers)
    return data


@pytest.fixture()
def user_token(test_client, user_register):
    """Sends POST request to /login endpoint and returns valid user token."""
    data = user_register
    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'}

    response = test_client.post(
        "/user/login", data=json.dumps(data), headers=headers)
    response_data = json.loads(response.data)
    token = response_data["token"]
    return token
